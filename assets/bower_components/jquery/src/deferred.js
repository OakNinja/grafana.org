define(["./core","./var/slice","./callbacks"],function(n,e){return n.extend({Deferred:function(e){var r=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],t="pending",a={state:function(){return t},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return n.Deferred(function(t){n.each(r,function(r,o){var s=n.isFunction(e[r])&&e[r];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&n.isFunction(e.promise)?e.promise().done(t.resolve).fail(t.reject).progress(t.notify):t[o[0]+"With"](this===a?t.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?n.extend(e,a):a}},i={};return a.pipe=a.then,n.each(r,function(n,e){var o=e[2],s=e[3];a[e[1]]=o.add,s&&o.add(function(){t=s},r[1^n][2].disable,r[2][2].lock),i[e[0]]=function(){return i[e[0]+"With"](this===i?a:this,arguments),this},i[e[0]+"With"]=o.fireWith}),a.promise(i),e&&e.call(i,i),i},when:function(r){var t,a,i,o=0,s=e.call(arguments),c=s.length,l=1!==c||r&&n.isFunction(r.promise)?c:0,p=1===l?r:n.Deferred(),u=function(n,r,a){return function(i){r[n]=this,a[n]=arguments.length>1?e.call(arguments):i,a===t?p.notifyWith(r,a):--l||p.resolveWith(r,a)}};if(c>1)for(t=new Array(c),a=new Array(c),i=new Array(c);c>o;o++)s[o]&&n.isFunction(s[o].promise)?s[o].promise().done(u(o,i,s)).fail(p.reject).progress(u(o,a,t)):--l;return l||p.resolveWith(i,s),p.promise()}}),n});