define(["./core","./var/slice","./callbacks"],function(e,n){return e.extend({Deferred:function(n){var t=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],r="pending",i={state:function(){return r},always:function(){return o.done(arguments).fail(arguments),this},then:function(){var n=arguments;return e.Deferred(function(r){e.each(t,function(t,u){var s=e.isFunction(n[t])&&n[t];o[u[1]](function(){var n=s&&s.apply(this,arguments);n&&e.isFunction(n.promise)?n.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[u[0]+"With"](this===i?r.promise():this,s?[n]:arguments)})}),n=null}).promise()},promise:function(n){return null!=n?e.extend(n,i):i}},o={};return i.pipe=i.then,e.each(t,function(e,n){var u=n[2],s=n[3];i[n[1]]=u.add,s&&u.add(function(){r=s},t[1^e][2].disable,t[2][2].lock),o[n[0]]=function(){return o[n[0]+"With"](this===o?i:this,arguments),this},o[n[0]+"With"]=u.fireWith}),i.promise(o),n&&n.call(o,o),o},when:function(t){var r,i,o,u=0,s=n.call(arguments),a=s.length,c=1!==a||t&&e.isFunction(t.promise)?a:0,d=1===c?t:e.Deferred(),l=function(e,t,i){return function(o){t[e]=this,i[e]=arguments.length>1?n.call(arguments):o,i===r?d.notifyWith(t,i):--c||d.resolveWith(t,i)}};if(a>1)for(r=new Array(a),i=new Array(a),o=new Array(a);a>u;u++)s[u]&&e.isFunction(s[u].promise)?s[u].promise().done(l(u,o,s)).fail(d.reject).progress(l(u,i,r)):--c;return c||d.resolveWith(o,s),d.promise()}}),e});