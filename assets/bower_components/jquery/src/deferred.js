define(["./core","./var/slice","./callbacks"],function(e,t){return e.extend({Deferred:function(t){var n=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],i="pending",r={state:function(){return i},always:function(){return o.done(arguments).fail(arguments),this},then:function(){var t=arguments;return e.Deferred(function(i){e.each(n,function(n,u){var s=e.isFunction(t[n])&&t[n];o[u[1]](function(){var t=s&&s.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().done(i.resolve).fail(i.reject).progress(i.notify):i[u[0]+"With"](this===r?i.promise():this,s?[t]:arguments)})}),t=null}).promise()},promise:function(t){return null!=t?e.extend(t,r):r}},o={};return r.pipe=r.then,e.each(n,function(e,t){var u=t[2],s=t[3];r[t[1]]=u.add,s&&u.add(function(){i=s},n[1^e][2].disable,n[2][2].lock),o[t[0]]=function(){return o[t[0]+"With"](this===o?r:this,arguments),this},o[t[0]+"With"]=u.fireWith}),r.promise(o),t&&t.call(o,o),o},when:function(n){var i,r,o,u=0,s=t.call(arguments),l=s.length,a=1!==l||n&&e.isFunction(n.promise)?l:0,d=1===a?n:e.Deferred(),c=function(e,n,r){return function(o){n[e]=this,r[e]=arguments.length>1?t.call(arguments):o,r===i?d.notifyWith(n,r):--a||d.resolveWith(n,r)}};if(l>1)for(i=new Array(l),r=new Array(l),o=new Array(l);l>u;u++)s[u]&&e.isFunction(s[u].promise)?s[u].promise().done(c(u,o,s)).fail(d.reject).progress(c(u,r,i)):--a;return a||d.resolveWith(o,s),d.promise()}}),e});