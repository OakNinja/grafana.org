define(["./core","./var/slice","./callbacks"],function(t,e){return t.extend({Deferred:function(e){var n=[["resolve","done",t.Callbacks("once memory"),"resolved"],["reject","fail",t.Callbacks("once memory"),"rejected"],["notify","progress",t.Callbacks("memory")]],i="pending",s={state:function(){return i},always:function(){return r.done(arguments).fail(arguments),this},then:function(){var e=arguments;return t.Deferred(function(i){t.each(n,function(n,o){var a=t.isFunction(e[n])&&e[n];r[o[1]](function(){var e=a&&a.apply(this,arguments);e&&t.isFunction(e.promise)?e.promise().done(i.resolve).fail(i.reject).progress(i.notify):i[o[0]+"With"](this===s?i.promise():this,a?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?t.extend(e,s):s}},r={};return s.pipe=s.then,t.each(n,function(t,e){var o=e[2],a=e[3];s[e[1]]=o.add,a&&o.add(function(){i=a},n[1^t][2].disable,n[2][2].lock),r[e[0]]=function(){return r[e[0]+"With"](this===r?s:this,arguments),this},r[e[0]+"With"]=o.fireWith}),s.promise(r),e&&e.call(r,r),r},when:function(n){var i,s,r,o=0,a=e.call(arguments),c=a.length,l=1!==c||n&&t.isFunction(n.promise)?c:0,u=1===l?n:t.Deferred(),d=function(t,n,s){return function(r){n[t]=this,s[t]=arguments.length>1?e.call(arguments):r,s===i?u.notifyWith(n,s):--l||u.resolveWith(n,s)}};if(c>1)for(i=new Array(c),s=new Array(c),r=new Array(c);c>o;o++)a[o]&&t.isFunction(a[o].promise)?a[o].promise().done(d(o,r,a)).fail(u.reject).progress(d(o,s,i)):--l;return l||u.resolveWith(r,a),u.promise()}}),t});