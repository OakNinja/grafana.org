var root=require("find-parent-dir").sync(__dirname,"package.json"),proxyquire=require("proxyquire").noPreserveCache(),metadata=require(root+"lib/metadata"),expect=require("expect.js"),Joi=require("joi");describe("cli/metadata",function(){it("should ignore .DS_STORE files",function(t){var e=proxyquire(root+"lib/metadata",{file:{walkSync:function(t,e){e("/",[],[".DS_Store"])}}});e(function(e){expect(e).to.be.an("array"),expect(e).to.have.length(0),t()})}),it("should throw on malformed metadata",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return"/*! { !*/"}}});expect(t).to.throwException(/Error Parsing Metadata/)}),it("should not throw when metadata is missing",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return"sup dude"}}});expect(t).to.not.throwException(/Error Parsing Metadata/)}),it("should throw on malformed deps",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return"define([[],"}}});expect(t).to.throwException(/Couldn't parse dependencies/)}),it("should throw if we can't find the define",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return"defin([]),"}}});expect(t).to.throwException(/Couldn't find the define/)}),it("should use amdPath as a fallback for name",function(){var t=proxyquire(root+"lib/metadata",{file:{walkSync:function(t,e){e("/",[],["fakeDetect.js"])}},fs:{readFileSync:function(){return'/*! { "property": "fake"}!*/ define([],'}}}),e=t();expect(e.name).to.equal(e.amdPath)}),it("should throw if we can't find the define",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return'/*! { "polyfills": ["fake"]}!*/ define([],'}}});expect(t).to.throwException(/Polyfill not found/)}),it("should throw if we can't find the define",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return'/*! { "property": "fake", "cssclass": "realFake"}!*/ define([],'}}}),e=t()[0];expect(e.cssclass).to.be(null)}),it("should rename `docs` to `doc` when found",function(){var t=proxyquire(root+"lib/metadata",{fs:{readFileSync:function(){return'/*! { "docs": "originally docs" }!*/ define([],'}}}),e=t()[0];expect(e.docs).to.be(void 0),expect(e.doc).to.match(/originally docs/)}),it("returns a json blob when invoked without callback",function(){expect(metadata()).to.be.an("array")}),it("return nothing when given a callback",function(){expect(metadata(function(){})).to.be(void 0)}),it("pass the json blob when given a callback",function(t){metadata(function(e){expect(e).to.be.an("array"),t()})}),describe("returns an array of valid objects",function(){var t=Joi.object().keys({amdPath:Joi.string().required(),name:Joi.string().required(),path:Joi.string().required(),doc:Joi.alternatives()["try"](Joi.string(),null),caniuse:Joi.alternatives()["try"](Joi.string(),null),async:Joi["boolean"](),aliases:Joi.array().items(Joi.string()),builderAliases:Joi.array().items(Joi.string()),knownBugs:Joi.array().items(Joi.string()),warnings:Joi.array().items(Joi.string()),authors:Joi.array().items(Joi.string()),tags:Joi.array().items(Joi.string()),deps:Joi.array().items(Joi.string()),notes:Joi.array().items(Joi.object().keys({name:Joi.string().required(),href:Joi.string().required()})).unique(),cssclass:Joi.alternatives()["try"](Joi.string().lowercase(),Joi.array().items(Joi.string().lowercase())).required(),property:Joi.alternatives()["try"](Joi.string().lowercase(),Joi.array().items(Joi.string().lowercase())).required(),polyfills:Joi.array().items(Joi.object().keys({name:Joi.string().required(),authors:Joi.array().items(Joi.string()),notes:Joi.array().items(Joi.string()),href:Joi.string().required(),licenses:Joi.array().items(Joi.string()).required()})).unique()});metadata(function(e){e.forEach(function(e){var n=t.validate(e).error;it("for "+e.name,function(){expect(n).to.be(null)})})})})});