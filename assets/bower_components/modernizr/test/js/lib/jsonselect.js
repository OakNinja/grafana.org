/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */
!function(e){function t(e){try{return JSON&&JSON.parse?JSON.parse(e):new Function("return "+e)()}catch(t){n("ijs")}}function n(e){throw new Error(d[e])}function r(e){return Array.isArray?Array.isArray(e):"[object Array]"===u.call(e)}function o(e){if(null===e)return"null";var t=typeof e;return"object"===t&&r(e)&&(t="array"),t}function a(e,t,n,r,a){var i,s=[],c=">"===t[0]?t[1]:t[0],u=!0;return c.type&&(u=u&&c.type===o(e)),c.id&&(u=u&&c.id===n),u&&c.pf&&(":nth-last-child"===c.pf?r=a-r:r++,0===c.a?u=c.b===r:(i=(r-c.b)%c.a,u=!i&&r*c.a+c.b>=0)),">"!==t[0]&&":root"!==t[0].pc&&s.push(t),u&&(">"===t[0]?t.length>2&&(u=!1,s.push(t.slice(2))):t.length>1&&(u=!1,s.push(t.slice(1)))),[u,s]}function i(e,t,n,o,s,c){var u,d,l=","===e[0]?e.slice(1):[e],f=[],m=!1,p=0,b=0,h=0;for(p=0;p<l.length;p++)for(d=a(t,l[p],o,s,c),d[0]&&(m=!0),b=0;b<d[1].length;b++)f.push(d[1][b]);if(f.length&&"object"==typeof t)if(f.length>=1&&f.unshift(","),r(t))for(p=0;p<t.length;p++)i(f,t[p],n,void 0,p,t.length);else{h=0;for(u in t)t.hasOwnProperty(u)&&h++;p=0;for(u in t)t.hasOwnProperty(u)&&i(f,t[u],n,u,p++,h)}m&&n&&n(t)}function s(e,t){var n=[];return i(e,t,function(e){n.push(e)}),n}function c(e){return{sel:b(e),match:function(e){return s(this.sel,e)},forEach:function(e,t){return i(this.sel,e,t)}}}var u=Object.prototype.toString,d={ijs:"invalid json string",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ujs:"unclosed json string",upc:"unrecognized pseudo class"},l={psc:1,psf:2,typ:3,str:4},f=/^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,m=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,p=function(e,r){r||(r=0);var o=f.exec(e.substr(r));if(!o)return void 0;r+=o[0].length;var a;return o[1]?a=[r," "]:o[2]?a=[r,o[0]]:o[3]?a=[r,l.typ,o[0]]:o[4]?a=[r,l.psc,o[0]]:o[5]?a=[r,l.psf,o[0]]:o[6]?n("upc"):o[7]?a=[r,l.str,t(o[0])]:o[8]?n("ujs"):o[9]&&(a=[r,l.str,o[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),a},b=function(e){for(var t,n=[],r=0;;){var o=h(e,r);if(n.push(o[1]),o=p(e,r=o[0]),o&&" "===o[1]&&(o=p(e,r=o[0])),!o)break;">"===o[1]?(n.push(">"),r=o[0]):","===o[1]&&(void 0===t?t=[",",n]:t.push(n),n=[],r=o[0])}return t&&t.push(n),t?t:n},h=function(e,t){var r=t,o={},a=p(e,t);for(a&&" "===a[1]&&(r=t=a[0],a=p(e,t)),a&&a[1]===l.typ?(o.type=a[2],a=p(e,t=a[0])):a&&"*"===a[1]&&(a=p(e,t=a[0]));;){if(void 0===a)break;if("."===a[1])a=p(e,t=a[0]),a&&a[1]===l.str||n("sra"),o.id&&n("nmi"),o.id=a[2];else if(a[1]===l.psc)(o.pc||o.pf)&&n("mpc"),":first-child"===a[2]?(o.pf=":nth-child",o.a=0,o.b=1):":last-child"===a[2]?(o.pf=":nth-last-child",o.a=0,o.b=1):o.pc=a[2];else{if(a[1]!==l.psf)break;(o.pc||o.pf)&&n("mpc"),o.pf=a[2];var i=m.exec(e.substr(a[0]));i||n("mepf"),i[5]?(o.a=2,o.b="odd"===i[5]?1:0):i[6]?(o.a=0,o.b=parseInt(i[6],10)):(o.a=parseInt((i[1]?i[1]:"+")+(i[2]?i[2]:"1"),10),o.b=i[3]?parseInt(i[3]+i[4],10):0),a[0]+=i[0].length}a=p(e,t=a[0])}return r===t&&n("se"),[t,o]};e._lex=p,e._parse=b,e.match=function(e,t){return c(e).match(t)},e.forEach=function(e,t,n){return c(e).forEach(t,n)},e.compile=c}("undefined"==typeof exports?window.JSONSelect={}:exports);